{% extends "base.html" %}

{% block title %}Album - {{ app_name }}{% endblock %}

{% block content %}
<div class="container">
    <div style="margin-bottom: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
                <h1 id="album-name"></h1>
                <p id="album-description" style="color: var(--text-secondary);"></p>
            </div>
            
            <div id="admin-actions" style="display: none;">
                <button id="edit-album-btn" class="btn btn-sm">Edit</button>
                <button id="share-album-btn" class="btn btn-sm">Share</button>
                <button id="delete-album-btn" class="btn btn-sm btn-danger">Delete</button>
            </div>
        </div>
        
        <div id="album-tags" style="margin-top: 1rem;"></div>
        
        <!-- Share Link Display -->
        <div id="share-link-section" style="display: none; margin-top: 1rem;">
            <h4>Share Link</h4>
            <input type="text" id="share-link-input" readonly style="width: 100%; max-width: 500px;">
            <button id="copy-share-link-btn" class="btn btn-sm">Copy Link</button>
            <button id="unshare-btn" class="btn btn-sm btn-secondary">Remove Share</button>
        </div>
    </div>
    
    <div id="album-media" class="gallery-grid"></div>
    
    <div id="loading-indicator" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p>Loading...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const albumId = "{{ album_id }}";
    let currentAlbum = null;
    let currentPage = 1;
    let hasMore = true;
    
    async function loadAlbum() {
        try {
            const response = await fetch(`/api/albums/${albumId}`);
            currentAlbum = await response.json();
            
            document.getElementById('album-name').textContent = currentAlbum.name;
            document.getElementById('album-description').textContent = currentAlbum.description || '';
            
            renderTags(currentAlbum.tags);
            
            if (app.isAdminMode) {
                document.getElementById('admin-actions').style.display = 'block';
            }
            
            if (currentAlbum.is_shared) {
                showShareLink(currentAlbum.share_uuid);
            }
            
            loadMedia();
        } catch (error) {
            console.error('Error loading album:', error);
        }
    }
    
    async function loadMedia() {
        if (!hasMore) return;
        
        document.getElementById('loading-indicator').style.display = 'block';
        
        try {
            const response = await fetch(`/api/albums/${albumId}/media?page=${currentPage}&limit=30`);
            const data = await response.json();
            
            renderMedia(data.items);
            
            currentPage++;
            hasMore = currentPage <= data.pages;
        } catch (error) {
            console.error('Error loading media:', error);
        } finally {
            document.getElementById('loading-indicator').style.display = 'none';
        }
    }
    
    function renderTags(tags) {
        const container = document.getElementById('album-tags');
        
        if (tags.length === 0) {
            container.innerHTML = '';
            return;
        }
        
        container.innerHTML = `
            <div class="tag-list">
                ${tags.map(tag => `
                    <a href="/?q=${encodeURIComponent(tag.name)}" class="tag ${tag.category}">
                        ${tag.name}
                    </a>
                `).join('')}
            </div>
        `;
    }
    
    function renderMedia(items) {
        const container = document.getElementById('album-media');
        
        items.forEach(item => {
            const div = document.createElement('a');
            div.href = `/media/${item.id}`;
            div.className = `gallery-item ${item.file_type}`;
            
            div.innerHTML = `<img src="/api/media/${item.id}/thumbnail" alt="${item.filename}" loading="lazy">`;
            
            container.appendChild(div);
        });
    }
    
    // Share album
    document.getElementById('share-album-btn').addEventListener('click', async () => {
        try {
            const result = await app.apiCall(`/api/albums/${albumId}/share`, {
                method: 'POST'
            });
            
            showShareLink(result.share_url.split('/').pop());
        } catch (error) {
            alert('Error creating share link: ' + error.message);
        }
    });
    
    function showShareLink(uuid) {
        const section = document.getElementById('share-link-section');
        const input = document.getElementById('share-link-input');
        
        input.value = `${window.location.origin}/shared/${uuid}`;
        section.style.display = 'block';
    }
    
    // Copy share link
    document.getElementById('copy-share-link-btn').addEventListener('click', () => {
        const input = document.getElementById('share-link-input');
        input.select();
        document.execCommand('copy');
        alert('Link copied to clipboard!');
    });
    
    // Unshare
    document.getElementById('unshare-btn').addEventListener('click', async () => {
        try {
            await app.apiCall(`/api/albums/${albumId}/share`, {
                method: 'DELETE'
            });
            
            document.getElementById('share-link-section').style.display = 'none';
            alert('Share link removed!');
        } catch (error) {
            alert('Error removing share: ' + error.message);
        }
    });
    
    // Delete album
    document.getElementById('delete-album-btn').addEventListener('click', async () => {
        if (currentAlbum.is_system) {
            alert('Cannot delete system album!');
            return;
        }
        
        if (!confirm('Are you sure you want to delete this album?')) return;
        
        try {
            await app.apiCall(`/api/albums/${albumId}`, {
                method: 'DELETE'
            });
            
            alert('Album deleted!');
            window.location.href = '/albums';
        } catch (error) {
            alert('Error deleting album: ' + error.message);
        }
    });
    
    // Infinite scroll
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting && hasMore) {
                loadMedia();
            }
        });
    }, {
        rootMargin: '200px'
    });
    
    observer.observe(document.getElementById('loading-indicator'));
    
    loadAlbum();
</script>
{% endblock %}
